<header class="top-header">
    <div class="d-flex align-items-center gap-3">
        <div class="user-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px; font-weight: 800; font-size: 1.2rem;">
            <span id="u-initial">-</span>
        </div>
        <div class="user-details" style="line-height: 1.2;">
            <div id="u-name" class="fw-bold" style="font-size: 15px; color: var(--text);">กำลังโหลด...</div>
            <div style="font-size: 11px; color: var(--text-muted);">
                <span id="u-pos">ตำแหน่ง</span> | <span id="u-dept">หน่วยงาน</span>
            </div>
        </div>
    </div>
    
    <div class="d-flex gap-2">
        <button class="btn-tool" onclick="toggleWidgetDropdown()"><i class="fas fa-th-large"></i></button>
        <button class="btn-tool" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
    </div>
</header>

<main class="main-content" id="view-news">
    <div id="announce-container">
        </div>
</main>

<script>
    // --- ฟังก์ชันคืนค่าข้อมูล User ---
    function displayUserInfo(data) {
        document.getElementById('u-name').innerText = data.name || "ไม่ระบุชื่อ";
        document.getElementById('u-pos').innerText = data.pos || "ไม่ระบุตำแหน่ง";
        document.getElementById('u-dept').innerText = data.dept || "ไม่ระบุหน่วยงาน";
        document.getElementById('u-initial').innerText = (data.nickname || data.name || "U")[0];
    }

    // --- ฟังก์ชันจัดการบอร์ด (แยกประกาศ & คอมเม้นต์) ---
    async function loadAnnounceBoard() {
        // ในอนาคต fetch จาก SCRIPT_URL?action=getAnnounce
        const announcements = [
            { 
                id: "A001", 
                title: "โปรโมชั่นเครื่องดูดควัน FE-301", 
                content: "ซื้อ 1 แถม 2 ถึงสิ้นเดือนนี้!", 
                author: "Moo", 
                img: "https://via.placeholder.com/400x200",
                comments: [
                    { user: "Golf", text: "รับทราบครับ เตรียมทำกราฟิกเพิ่ม" },
                    { user: "Aum", text: "ยอดจองเริ่มเข้ามาแล้วครับ" }
                ]
            }
        ];

        const container = document.getElementById('announce-container');
        container.innerHTML = announcements.map(post => `
            <div class="widget-card mb-4 p-0 overflow-hidden shadow-sm">
                <div class="p-3">
                    <h6 class="fw-bold text-primary mb-1">${post.title}</h6>
                    <small class="text-muted">โดย: ${post.author}</small>
                    <p class="mt-2" style="font-size: 14px;">${post.content}</p>
                </div>
                ${post.img ? `<img src="${post.img}" style="width:100%;">` : ''}
                
                <div class="bg-light p-3" style="font-size: 13px; border-top: 1px solid #eee;">
                    <div class="fw-bold mb-2">คอมเม้นต์:</div>
                    <div id="comments-${post.id}">
                        ${post.comments.map(c => `<div class="mb-1"><b>${c.user}:</b> ${c.text}</div>`).join('')}
                    </div>
                    
                    <div class="input-group mt-2">
                        <input type="text" id="inp-${post.id}" class="form-control form-control-sm" placeholder="พิมพ์คอมเม้นต์...">
                        <button class="btn btn-primary btn-sm" onclick="sendComment('${post.id}')">ส่ง</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function sendComment(postId) {
        const text = document.getElementById(`inp-${postId}`).value;
        const userName = sessionData.name; // ดึงจาก Login
        
        if(!text) return;

        // บันทึกไปที่ Apps Script (ส่ง action: 'addComment', postId, user, text)
        const payload = { action: 'addComment', postId, user: userName, text };
        
        // อัปเดต UI ทันที (Optimistic Update)
        const commentBox = document.getElementById(`comments-${postId}`);
        commentBox.innerHTML += `<div class="mb-1"><b>${userName}:</b> ${text}</div>`;
        document.getElementById(`inp-${postId}`).value = '';
    }

    // เรียกใช้ตอน App เริ่มทำงาน
    // initApp(JSON.parse(localStorage.getItem("user_session")));
</script>
