<!DOCTYPE html>
<html lang="th" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ULKA SYSTEM v20.26 (Live Database)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --primary-hue: 211; --primary: hsl(var(--primary-hue), 100%, 50%); --primary-soft: hsl(var(--primary-hue), 100%, 95%); --bg-body: #f0f2f5; --bg-sidebar: #ffffff; --bg-card: #ffffff; --text-main: #344767; --text-muted: #8392ab; --border-color: rgba(0,0,0,0.05); --shadow-card: 0 2px 10px rgba(0,0,0,0.03); --sidebar-width: 260px; }
        [data-theme="dark"] { --bg-body: #111827; --bg-sidebar: #1f2937; --bg-card: #1f2937; --text-main: #f9fafb; --text-muted: #9ca3af; --border-color: rgba(255,255,255,0.1); --shadow-card: 0 4px 20px rgba(0,0,0,0.3); --primary-soft: hsl(var(--primary-hue), 50%, 20%); }
        body { height: 100vh; margin: 0; font-family: 'Sarabun', sans-serif; background: var(--bg-body); color: var(--text-main); overflow: hidden; }
        #main-app { display: flex; height: 100%; transition: 0.3s; }
        
        /* Sidebar Styles */
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 15px 10px; flex-shrink: 0; transition: all 0.3s ease; z-index: 1000; overflow-y: auto; }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text, .sidebar.collapsed .sidebar-brand-text, .sidebar.collapsed .nav-section, .sidebar.collapsed .sidebar-footer, .sidebar.collapsed .fa-chevron-down { display: none; }
        
        .nav-item { padding: 10px 15px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; gap: 12px; font-size: 0.95rem; transition: 0.2s; font-weight: 600; position: relative; }
        .nav-item:hover { background: var(--primary-soft); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: #fff !important; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .nav-section { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-top: 10px; padding: 8px 15px; font-weight: 800; opacity: 0.8; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        
        @media (max-width: 768px) { .sidebar { position: fixed; height: 100%; left: -100%; width: 260px; } .sidebar.show { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.2); } .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; } .sidebar-overlay.show { display: block; } }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; width: 100%; }
        .top-navbar { height: 60px; background: var(--bg-card); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--border-color); }
        .content-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        .content-scroll.iframe-mode { padding: 0; overflow: hidden; }
        
        iframe { width: 100%; height: 100%; border: none; display: block; }
        .theme-btn { width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebarMobile()"></div>
    
    <div id="login-screen" style="position:fixed; inset:0; background:#0f172a; z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div class="bg-white p-4 rounded-4 text-center shadow-lg" style="width:350px;">
            <i class="fas fa-cube fa-3x text-primary mb-3"></i>
            <h4 class="fw-bold text-dark">ULKA SYSTEM</h4>
            <div class="form-group text-start mb-3">
                <input type="text" id="user" class="form-control mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (User ID)">
                <input type="password" id="pass" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)">
            </div>
            <div class="form-check text-start mb-3">
                <input class="form-check-input" type="checkbox" id="rememberMe">
                <label class="form-check-label small text-muted" for="rememberMe">‡∏à‡∏≥‡∏â‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</label>
            </div>
            <button onclick="checkLogin()" id="login-btn" class="btn btn-primary w-100 py-2 fw-bold">Login</button>
            <p id="login-error" class="text-danger mt-2 small d-none">Login Failed!</p>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div class="sidebar" id="sidebar">
            <div class="px-2 pb-3 pt-2 fw-bold d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2"><i class="fas fa-cube brand-icon fa-lg"></i><span class="sidebar-brand-text">ULKA v20.26</span></div>
                <i class="fas fa-bars text-muted cursor-pointer d-none d-md-block" onclick="toggleSidebarDesktop()"></i>
            </div>

            <div onclick="switchView('news', this)" id="nav-news" class="nav-item active mt-2" data-name="‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ (News)">
                <i class="fas fa-newspaper nav-icon"></i> <span class="nav-text">‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ (News)</span>
            </div>

            <div class="nav-section allow-admin allow-manager" data-bs-toggle="collapse" data-bs-target="#menu-executive">
                <span>Executive</span> <i class="fas fa-chevron-down"></i>
            </div>
            <div class="collapse show allow-admin allow-manager" id="menu-executive">
                <div onclick="switchView('biz', this)" class="nav-item" data-name="‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô">
                    <i class="fas fa-briefcase nav-icon"></i> <span class="nav-text">‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</span>
                </div>
                <div onclick="switchView('stock', this)" class="nav-item" data-name="‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                    <i class="fas fa-boxes nav-icon"></i> <span class="nav-text">‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                </div>
            </div>

            <div class="nav-section" data-bs-toggle="collapse" data-bs-target="#menu-operation">
                <span>Operation</span> <i class="fas fa-chevron-down"></i>
            </div>
            <div class="collapse show" id="menu-operation">
                <div onclick="switchView('install', this)" class="nav-item" data-name="‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á">
                    <i class="fas fa-tools nav-icon"></i> <span class="nav-text">‡πÅ‡∏û‡∏•‡∏ô‡∏á‡∏≤‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</span>
                </div>
                <div onclick="switchView('joy_fix', this)" class="nav-item allow-admin allow-manager" data-name="‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°">
                    <i class="fas fa-wrench nav-icon"></i> <span class="nav-text">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (Joy Fix)</span>
                </div>
            </div>

            <div class="mt-auto p-2">
                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded mb-2 border">
                    <div class="small fw-bold">Dark Mode</div>
                    <div class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" id="darkModeToggle" onchange="toggleTheme()"></div>
                </div>
                <div class="nav-item text-danger justify-content-center" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> <span class="nav-text">Logout</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="top-navbar">
                <div class="d-flex align-items-center gap-3">
                    <i class="fas fa-bars d-md-none text-muted" onclick="toggleSidebarMobile()"></i>
                    <div class="d-flex align-items-center gap-2"><i class="fas fa-user-circle text-primary fa-lg"></i><small class="fw-bold" id="user-display">Loading...</small></div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex gap-1">
                        <div class="theme-btn" style="background:#0d6efd;" onclick="setColor(211, this)"></div>
                        <div class="theme-btn" style="background:#dc3545;" onclick="setColor(354, this)"></div>
                        <div class="theme-btn" style="background:#198754;" onclick="setColor(152, this)"></div>
                    </div>
                    <span class="badge bg-light text-dark border"><span id="clock">00:00</span></span>
                </div>
            </div>

            <div id="content-container" class="content-scroll">
                <div id="view-news" class="view-section">
                    <h4 class="fw-bold text-primary"><i class="fas fa-bullhorn"></i> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h4>
                    <hr>
                    <div class="alert alert-info">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì <span id="welcome-name"></span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ULKA</div>
                </div>
                <div id="view-iframe" class="view-section" style="display:none; height:100%;">
                    <iframe id="main-iframe" src=""></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üöÄ 1. ‡πÉ‡∏™‡πà Web App URL ‡∏à‡∏≤‡∏Å Apps Script ‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üöÄ
        const GOOGLE_SCRIPT_URL = "‡πÉ‡∏™‡πà_WEB_APP_URL_‡∏Ç‡∏≠‡∏á‡∏û‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà";

        const AUTO_LOGOUT_TIME = 2 * 60 * 60 * 1000;
        let logoutTimer;

        // üü¢ LOGIN SYSTEM (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡∏µ‡∏ï)
        async function checkLogin() {
            const u = document.getElementById('user').value.trim();
            const p = document.getElementById('pass').value.trim();
            const remember = document.getElementById('rememberMe').checked;
            const btn = document.getElementById('login-btn');
            const error = document.getElementById('login-error');

            if(!u || !p) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å User ID ‡πÅ‡∏•‡∏∞ Password', 'warning');

            btn.disabled = true;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";
            error.classList.add('d-none');

            try {
                // ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà doGet ‡πÉ‡∏ô Code.gs ‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡πÅ‡∏Å‡πâ‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ
                const resp = await fetch(`${GOOGLE_SCRIPT_URL}?action=login&user=${u}&pass=${p}`);
                const res = await resp.json();

                if(res.success) {
                    const userData = { user: res.user, role: res.role, name: res.name };
                    if(remember) localStorage.setItem("user", JSON.stringify(userData));
                    else sessionStorage.setItem("user", JSON.stringify(userData));
                    
                    initApp(userData);
                    Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${res.name}`, timer: 1500, showConfirmButton: false });
                } else {
                    error.innerText = res.message;
                    error.classList.remove('d-none');
                    Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', res.message, 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏î‡πâ', 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = "Login";
            }
        }

        function initApp(user) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('user-display').innerText = user.name;
            document.getElementById('welcome-name').innerText = user.name;

            // üõ°Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Permission Control)
            document.querySelectorAll('.allow-admin, .allow-manager').forEach(el => el.style.display = 'none');
            if(user.role === 'admin') {
                document.querySelectorAll('.allow-admin, .allow-manager').forEach(el => el.style.display = 'block');
            } else if(user.role === 'manager') {
                document.querySelectorAll('.allow-manager').forEach(el => el.style.display = 'block');
            }

            startClock();
            resetAutoLogout();
            initTheme();
        }

        function switchView(viewId, el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
            
            const container = document.getElementById('content-container');
            const iframe = document.getElementById('main-iframe');

            if(viewId === 'news') {
                container.classList.remove('iframe-mode');
                document.getElementById('view-news').style.display = 'block';
                document.getElementById('view-iframe').style.display = 'none';
            } else {
                container.classList.add('iframe-mode');
                document.getElementById('view-news').style.display = 'none';
                document.getElementById('view-iframe').style.display = 'block';
                
                let urlMap = { 
                    'biz': 'Biz_plan.html', 'stock': 'Product_plan.html', 
                    'install': 'Onsite_Servier.html', 'joy_fix': 'joy_fix.html' 
                };
                iframe.src = urlMap[viewId] ? urlMap[viewId] + "?auth=ok" : "";
            }
        }

        function logout() {
            localStorage.removeItem("user");
            sessionStorage.clear();
            location.reload();
        }

        function startClock() {
            setInterval(() => {
                document.getElementById('clock').innerText = new Date().toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            }, 1000);
        }

        function resetAutoLogout() {
            clearTimeout(logoutTimer);
            logoutTimer = setTimeout(() => {
                Swal.fire('Timeout', '‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'info').then(logout);
            }, AUTO_LOGOUT_TIME);
        }

        // Theme & UI Utils
        function toggleTheme() {
            const isDark = document.getElementById('darkModeToggle').checked;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('darkModeToggle').checked = (theme === 'dark');
        }
        function setColor(hue) {
            document.documentElement.style.setProperty('--primary-hue', hue);
        }
        function toggleSidebarDesktop() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function toggleSidebarMobile() { 
            document.getElementById('sidebar').classList.toggle('show');
            document.getElementById('sidebar-overlay').classList.toggle('show');
        }

        window.onload = () => {
            const savedUser = localStorage.getItem("user") || sessionStorage.getItem("user");
            if(savedUser) initApp(JSON.parse(savedUser));
        };
    </script>
</body>
</html>
