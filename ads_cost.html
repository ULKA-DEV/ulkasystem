<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Planner: Auto-Save System</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- GENERAL --- */
        body { font-family: 'Prompt', sans-serif; background: #f3f4f6; padding: 20px; color: #333; -webkit-print-color-adjust: exact; }
        .container { max-width: 98%; margin: 0 auto; }

        /* --- CONTROL & MENU --- */
        .control-box {
            background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px; border-top: 5px solid #2563eb;
        }
        .menu-bar { display: flex; gap: 10px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; justify-content: flex-end; align-items: center;}
        
        /* Auto Save Indicator */
        .save-status { font-size: 12px; color: #16a34a; margin-right: auto; display: flex; align-items: center; gap: 5px; opacity: 0; transition: opacity 0.5s; }
        .save-status.show { opacity: 1; }

        .btn-tool { border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px; transition: 0.2s; font-family: 'Prompt'; }
        .btn-save { background: #10b981; color: white; }
        .btn-load { background: #f59e0b; color: white; }
        .btn-reset { background: #ef4444; color: white; }
        .btn-print { background: #2c3e50; color: white; }

        .control-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .input-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 5px; }
        .input-group input, .input-group select { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; outline: none; }
        .btn-action { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; height: 38px; }

        /* --- SUMMARY --- */
        .summary-panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        table.sum-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        table.sum-table th { background: #1e293b; color: white; padding: 10px; text-align: right; }
        table.sum-table th:first-child { text-align: left; border-radius: 8px 0 0 0; }
        table.sum-table th:last-child { border-radius: 0 8px 0 0; }
        table.sum-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: right; font-weight: 500; }
        table.sum-table td:first-child { text-align: left; font-weight: bold; }
        .row-total td { background: #f0fdf4; font-weight: 800; color: #166534; border-top: 2px solid #16a34a; font-size: 1.1em; }

        /* --- ROI CALCULATOR --- */
        .calc-box {
            background: linear-gradient(to right, #fff7ed, #fff);
            padding: 20px; border-radius: 12px; margin-bottom: 20px;
            border: 1px solid #fed7aa; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .roi-input-area { display: flex; align-items: center; gap: 10px; }
        .roi-display { text-align: right; }
        .roi-val { font-size: 2em; font-weight: 800; line-height: 1; }
        .roi-desc { font-size: 14px; margin-top: 5px; font-weight: bold; }

        /* --- TABLE STYLING --- */
        .table-scroll { overflow-x: auto; background: white; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e5e7eb; max-height: 65vh; }
        table.daily { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1500px; font-size: 13px; }
        
        table.daily th { 
            background: #f8fafc; position: sticky; top: 0; z-index: 10;
            padding: 10px 5px; border-bottom: 2px solid #94a3b8; color: #334155; text-align: center;
            min-width: 85px; font-weight: 700;
        }
        table.daily td:first-child, table.daily th:first-child { 
            position: sticky; left: 0; z-index: 20; background: white; 
            border-right: 2px solid #cbd5e1; min-width: 160px; text-align: left; padding-left: 15px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.02);
        }
        table.daily th:first-child { z-index: 30; background: #e2e8f0; text-align: center; }

        /* Platform Color Bands */
        .plat-label-shopee { background-color: #fff7ed !important; color: #c2410c; border-left: 6px solid #ee4d2d !important; font-weight: bold; }
        .plat-label-facebook { background-color: #eff6ff !important; color: #1e40af; border-left: 6px solid #1877f2 !important; font-weight: bold; }
        .plat-label-google { background-color: #fef2f2 !important; color: #991b1b; border-left: 6px solid #ea4335 !important; font-weight: bold; }
        
        /* Separator */
        .group-separator td { border-bottom: 4px solid #cbd5e1 !important; }

        table.daily td { border-bottom: 1px solid #f1f5f9; padding: 0; height: 38px; }
        .is-weekend { background-color: #fce7f3 !important; color: #9d174d; font-weight: bold; }
        .is-today { background-color: #fef08a !important; border-bottom: 2px solid #ca8a04 !important; }

        .inp-cell { width: 100%; height: 100%; border: none; text-align: center; background: transparent; font-family: 'Prompt'; font-size: 13px; }
        .inp-cell:focus { background: #e0e7ff; outline: none; }
        .inp-top { color: #15803d; font-weight: 800; }
        .inp-use { color: #b91c1c; }
        
        .row-bal td { background-color: #f8fafc; color: #64748b; font-size: 12px; font-weight: bold; }
        .bal-cell { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; }

        .warn-low { background-color: #ffedd5 !important; color: #c2410c !important; font-weight: 800; border: 2px solid #f97316; }
        .warn-empty { background-color: #fee2e2 !important; color: #b91c1c !important; opacity: 0.6; }

        /* PRINT */
        @media print {
            .control-box, .menu-bar, .btn-action { display: none !important; }
            .table-scroll { overflow: visible; border: none; max-height: none; }
            table.daily th, table.daily td { border: 1px solid #ccc; }
            .plat-label-shopee { background-color: #fff7ed !important; -webkit-print-color-adjust: exact; }
            .plat-label-facebook { background-color: #eff6ff !important; -webkit-print-color-adjust: exact; }
            .plat-label-google { background-color: #fef2f2 !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="container">

    <div style="display:none;" id="printHeader">
        <h2 style="text-align:center;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ (Ad Budget Plan)</h2>
        <div style="text-align:center; margin-bottom:20px;">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: <span id="printDate"></span></div>
    </div>

    <div class="control-box">
        <div class="menu-bar">
            <div id="saveStatus" class="save-status"><i class="fas fa-check-circle"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</div>

            <button class="btn-tool btn-print" onclick="window.print()"><i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            <button class="btn-tool btn-save" onclick="saveToFile()"><i class="fas fa-save"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå</button>
            <button class="btn-tool btn-load" onclick="document.getElementById('fileInput').click()"><i class="fas fa-folder-open"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤</button>
            <input type="file" id="fileInput" hidden onchange="loadFromFile(this)" accept=".json">
            <button class="btn-tool btn-reset" onclick="resetAll()"><i class="fas fa-trash-alt"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div class="control-header">
            <h3 style="margin:0; color:#2563eb;"><i class="fas fa-calendar-alt"></i> ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏á‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
            <div style="display:flex; align-items:center; gap:10px;">
                <label style="font-weight:bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                <input type="month" id="monthPicker" onchange="changeMonth();" style="font-size:16px; font-weight:bold; border:2px solid #2563eb; padding:5px; border-radius:6px;">
            </div>
        </div>

        <div class="input-row">
            <div class="input-group">
                <label>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</label>
                <select id="sel-plat">
                    <option value="shopee">Shopee</option>
                    <option value="facebook">Facebook</option>
                    <option value="google">Google</option>
                </select>
            </div>
            <div class="input-group">
                <label>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <select id="sel-day" style="min-width: 70px;"></select>
            </div>
            <div class="input-group">
                <label>‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô</label>
                <input type="number" id="inp-budget" placeholder="0">
            </div>
            <div class="input-group">
                <label>‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏•‡∏∞</label>
                <input type="number" id="inp-daily" placeholder="0">
            </div>
            <div class="input-group">
                <label>&nbsp;</label>
                <button class="btn-action" onclick="applyPlan()">üëá ‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <div class="summary-panel">
        <h4 style="margin:0 0 10px 0;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡πÅ‡∏¢‡∏Å‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°)</h4>
        <table class="sum-table">
            <thead>
                <tr>
                    <th>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</th>
                    <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏ß‡∏°</th>
                    <th>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏£‡∏ß‡∏°</th>
                    <th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                </tr>
            </thead>
            <tbody id="summary-body"></tbody>
            <tfoot>
                <tr class="row-total">
                    <td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Grand Total)</td>
                    <td id="grand-top">0.00</td>
                    <td id="grand-use">0.00</td>
                    <td id="grand-bal">0.00</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="calc-box">
        <div class="roi-input-area">
            <div style="background:#2563eb; color:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px;">
                <i class="fas fa-calculator"></i>
            </div>
            <div>
                <label style="font-weight:bold; display:block; color:#475569;">üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Revenue):</label>
                <input type="number" id="revenue" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢..." style="padding:10px; border:2px solid #cbd5e1; border-radius:6px; width:200px; font-weight:bold; font-size:1.1em;" oninput="calcROI()">
                <span style="font-weight:bold;">‡∏ö‡∏≤‡∏ó</span>
            </div>
        </div>
        
        <div class="roi-display">
            <div style="font-size:14px; color:#64748b;">Target: ‚â§ 4% | Max: 6%</div>
            <div class="roi-val" id="roi-res">0.00%</div>
            <div class="roi-desc" id="roi-status">-</div>
        </div>
    </div>

    <div class="table-scroll">
        <table class="daily" id="dailyTable">
            <thead>
                <tr id="header-row">
                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

</div>

<script>
    const platforms = [
        { id: 'shopee', name: 'Shopee', color: '#ee4d2d', icon: 'fas fa-shopping-bag' },
        { id: 'facebook', name: 'Facebook', color: '#1877f2', icon: 'fab fa-facebook' },
        { id: 'google', name: 'Google', color: '#ea4335', icon: 'fab fa-google' }
    ];

    let currentYear, currentMonth, daysInMonth;

    function init() {
        // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Cache ‡∏Å‡πà‡∏≠‡∏ô
        const loaded = loadFromCache();
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Cache ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        if (!loaded) {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('monthPicker').value = `${yyyy}-${mm}`;
            changeMonth();
        }
    }

    function changeMonth() {
        const picker = document.getElementById('monthPicker').value;
        if (!picker) return;

        const date = new Date(picker + "-01");
        
        currentYear = date.getFullYear();
        currentMonth = date.getMonth();
        daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        
        if(document.getElementById('printDate')) document.getElementById('printDate').innerText = picker;

        renderTable();
        updateDaySelect();
        calcAll(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ã‡∏ü
    }

    function updateDaySelect() {
        const sel = document.getElementById('sel-day');
        sel.innerHTML = '';
        for(let i=1; i<=daysInMonth; i++) {
            let opt = document.createElement('option'); opt.value = i; opt.innerText = i; sel.appendChild(opt);
        }
    }

    function renderTable() {
        const headerRow = document.getElementById('header-row');
        const tbody = document.getElementById('table-body');
        
        headerRow.innerHTML = '<th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>';
        tbody.innerHTML = '';

        for (let i = 1; i <= daysInMonth; i++) {
            const th = document.createElement('th');
            const dateObj = new Date(currentYear, currentMonth, i);
            const dayName = dateObj.toLocaleDateString('th-TH', { weekday: 'short' });
            const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
            const today = new Date();
            const isToday = (today.getDate() === i && today.getMonth() === currentMonth && today.getFullYear() === currentYear);

            if (isWeekend) th.classList.add('is-weekend');
            if (isToday) th.classList.add('is-today');

            th.innerHTML = `<span style="font-size:10px; display:block;">${dayName}</span><span style="font-size:14px;">${i}</span>`;
            headerRow.appendChild(th);
        }

        platforms.forEach((p) => {
            let trTop = document.createElement('tr');
            trTop.innerHTML = `<td class="plat-label-${p.id}">${p.name} (‡πÄ‡∏ï‡∏¥‡∏°)</td>`;
            
            let trUse = document.createElement('tr');
            trUse.innerHTML = `<td class="plat-label-${p.id}" style="font-weight:normal; opacity:0.8;">‚Ü≥ ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á</td>`;

            let trBal = document.createElement('tr');
            trBal.className = 'row-bal group-separator';
            trBal.innerHTML = `<td class="plat-label-${p.id}" style="font-weight:normal; opacity:0.8;">= ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</td>`;

            for(let i=1; i<=daysInMonth; i++) {
                const dateObj = new Date(currentYear, currentMonth, i);
                const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
                const today = new Date();
                const isToday = (today.getDate() === i && today.getMonth() === currentMonth && today.getFullYear() === currentYear);
                
                let cls = '';
                if(isWeekend) cls += ' is-weekend';
                if(isToday) cls += ' is-today';

                trTop.innerHTML += `<td class="${cls}"><input type="number" class="inp-cell inp-top" data-plat="${p.id}" data-type="top" data-day="${i}" oninput="calcAll()"></td>`;
                trUse.innerHTML += `<td class="${cls}"><input type="number" class="inp-cell inp-use" data-plat="${p.id}" data-type="use" data-day="${i}" oninput="calcAll()"></td>`;
                trBal.innerHTML += `<td class="${cls}"><div class="bal-cell" id="bal-${p.id}-${i}"></div></td>`;
            }
            
            tbody.appendChild(trTop);
            tbody.appendChild(trUse);
            tbody.appendChild(trBal);
        });
        
        // Summary Body
        const sumBody = document.getElementById('summary-body');
        sumBody.innerHTML = '';
        platforms.forEach(p => {
            sumBody.innerHTML += `<tr><td style="color:${p.color};"><i class="${p.icon}"></i> ${p.name}</td><td id="sum-top-${p.id}">0.00</td><td id="sum-use-${p.id}">0.00</td><td id="sum-bal-${p.id}">0.00</td></tr>`;
        });
    }

    function applyPlan() {
        const pId = document.getElementById('sel-plat').value;
        const startDay = parseInt(document.getElementById('sel-day').value);
        const budget = parseFloat(document.getElementById('inp-budget').value);
        const daily = parseFloat(document.getElementById('inp-daily').value);

        if(!budget || !daily) { alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö"); return; }

        const topCell = document.querySelector(`.inp-cell[data-plat="${pId}"][data-type="top"][data-day="${startDay}"]`);
        if(topCell) topCell.value = budget;

        let remaining = budget;
        for(let i=startDay; i<=daysInMonth; i++) {
            const cell = document.querySelector(`.inp-cell[data-plat="${pId}"][data-type="use"][data-day="${i}"]`);
            if(cell) cell.value = "";
        }

        for(let i=startDay; i<=daysInMonth; i++) {
            const useCell = document.querySelector(`.inp-cell[data-plat="${pId}"][data-type="use"][data-day="${i}"]`);
            if(useCell) {
                if(remaining >= daily) { useCell.value = daily; remaining -= daily; }
                else if (remaining > 0) { useCell.value = remaining; remaining = 0; }
                else { break; }
            }
        }
        calcAll();
    }

    function calcAll() {
        let gTop = 0, gUse = 0;
        const dailyRateSet = parseFloat(document.getElementById('inp-daily').value) || 0; 

        platforms.forEach(p => {
            let pTop = 0, pUse = 0;
            let runningBal = 0;
            let isDepleted = false;

            for(let i=1; i<=daysInMonth; i++) {
                const tVal = parseFloat(document.querySelector(`.inp-cell[data-plat="${p.id}"][data-type="top"][data-day="${i}"]`).value) || 0;
                const uVal = parseFloat(document.querySelector(`.inp-cell[data-plat="${p.id}"][data-type="use"][data-day="${i}"]`).value) || 0;
                const balCell = document.getElementById(`bal-${p.id}-${i}`);

                if(tVal > 0) isDepleted = false;

                runningBal = runningBal + tVal - uVal;
                pTop += tVal; pUse += uVal;

                balCell.className = 'bal-cell';
                balCell.parentElement.className = balCell.parentElement.className.replace(/warn-\w+/g, ''); 

                if (isDepleted) {
                    balCell.innerText = "-";
                    balCell.parentElement.classList.add('warn-empty');
                } else {
                    balCell.innerText = runningBal.toLocaleString();

                    if (runningBal <= 0 || (runningBal === 0 && uVal > 0)) {
                        balCell.parentElement.classList.add('warn-empty');
                        isDepleted = true;
                    } else {
                        // Advance Warning
                        let nextCost = dailyRateSet > 0 ? dailyRateSet : uVal;
                        if (runningBal < nextCost && runningBal > 0) {
                            balCell.innerHTML = `${runningBal}<br><span style="font-size:9px;color:#c2410c;">‚ö† ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span>`;
                            balCell.parentElement.classList.add('warn-low');
                        }
                    }
                }
            }
            document.getElementById(`sum-top-${p.id}`).innerText = pTop.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById(`sum-use-${p.id}`).innerText = pUse.toLocaleString(undefined, {minimumFractionDigits:2});
            document.getElementById(`sum-bal-${p.id}`).innerText = (pTop - pUse).toLocaleString(undefined, {minimumFractionDigits:2});
            gTop += pTop; gUse += pUse;
        });

        document.getElementById('grand-top').innerText = gTop.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('grand-use').innerText = gUse.toLocaleString(undefined, {minimumFractionDigits:2});
        document.getElementById('grand-bal').innerText = (gTop - gUse).toLocaleString(undefined, {minimumFractionDigits:2});

        calcROI(gUse);
        saveToCache(); // AUTO SAVE EVERY TIME
    }

    function calcROI(totalSpend) {
        if(totalSpend === undefined) totalSpend = parseFloat(document.getElementById('grand-use').innerText.replace(/,/g,'')) || 0;
        const rev = parseFloat(document.getElementById('revenue').value) || 0;
        const resBox = document.getElementById('roi-res');
        const statBox = document.getElementById('roi-status');

        if(rev > 0) {
            const percent = (totalSpend / rev) * 100;
            resBox.innerText = percent.toFixed(2) + "%";
            
            if(percent > 6) {
                resBox.style.color = "#dc2626"; statBox.innerText = "üî¥ ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (‡πÄ‡∏Å‡∏¥‡∏ô‡∏•‡∏¥‡∏°‡∏¥‡∏ï 6%)"; statBox.style.color = "#dc2626";
            } else if (percent > 4) {
                resBox.style.color = "#ea580c"; statBox.innerText = "üü† ‡∏û‡∏≠‡πÉ‡∏ä‡πâ / ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á (4-6%)"; statBox.style.color = "#ea580c";
            } else {
                resBox.style.color = "#16a34a"; statBox.innerText = "üü¢ ‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (‚â§ 4%)"; statBox.style.color = "#16a34a";
            }
        } else {
            resBox.innerText = "0.00%"; statBox.innerText = "-";
        }
        saveToCache();
    }

    // --- AUTO SAVE / CACHE SYSTEM ---
    function saveToCache() {
        const data = {
            month: document.getElementById('monthPicker').value,
            revenue: document.getElementById('revenue').value,
            cells: []
        };
        document.querySelectorAll('.inp-cell').forEach(inp => {
            if(inp.value) data.cells.push({ plat: inp.dataset.plat, type: inp.dataset.type, day: inp.dataset.day, val: inp.value });
        });
        localStorage.setItem('adPlannerData', JSON.stringify(data));
        
        // Show indicator
        const status = document.getElementById('saveStatus');
        status.classList.add('show');
        setTimeout(() => status.classList.remove('show'), 2000);
    }

    function loadFromCache() {
        const cached = localStorage.getItem('adPlannerData');
        if(!cached) return false;

        try {
            const data = JSON.parse(cached);
            document.getElementById('monthPicker').value = data.month;
            changeMonth(); // Build table structure first

            document.getElementById('revenue').value = data.revenue;

            // Fill Cells
            data.cells.forEach(item => {
                const el = document.querySelector(`.inp-cell[data-plat="${item.plat}"][data-type="${item.type}"][data-day="${item.day}"]`);
                if(el) el.value = item.val;
            });
            
            // Recalculate without saving again immediately (optional optimization, but calcAll saves anyway)
            // Just call calcAll is fine
            calcAll(); 
            return true;
        } catch(e) {
            console.error("Cache Error", e);
            return false;
        }
    }

    // --- FILE SAVE / LOAD ---
    function saveToFile() {
        const cached = localStorage.getItem('adPlannerData');
        if(!cached) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"); return; }
        const blob = new Blob([cached], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `AdPlan_Backup.json`; a.click();
    }

    function loadFromFile(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                localStorage.setItem('adPlannerData', e.target.result);
                loadFromCache();
                alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
            } catch(err) { alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚ùå"); }
            input.value = '';
        };
        reader.readAsText(file);
    }

    function resetAll() { 
        if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢)")) { 
            localStorage.removeItem('adPlannerData');
            location.reload(); 
        } 
    }

    init();
</script>

</body>
</html>
