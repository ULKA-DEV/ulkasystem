<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: transparent; padding: 15px; text-align: left; color: #1e293b; }
        .war-card { background: #fff; border-radius: 20px; padding: 25px; border: 1px solid #e2e8f0; height: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-value { font-size: 2rem; font-weight: 800; color: #007bff; }
        .progress { height: 15px; border-radius: 10px; margin: 15px 0; background: #f1f5f9; }
        .input-target { border: 2px solid #007bff; border-radius: 10px; width: 150px; text-align: center; font-weight: 800; color: #007bff; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-bold mb-0">üöÄ Sales War Room (Real-time)</h4>
            <div class="bg-white px-3 py-2 rounded-pill shadow-sm border small fw-bold">
                ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <input type="number" id="target-val" class="input-target mx-2" value="8000000" oninput="calculate()"> ‡∏ø
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="war-card border-top border-primary border-4">
                    <small class="text-muted fw-bold text-uppercase">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Sale Team)</small>
                    <div class="stat-value" id="cur-sales">‡∏ø0</div>
                    <div class="progress"><div id="prog-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%"></div></div>
                    <div class="small fw-bold text-primary" id="prog-pct">0% ‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="war-card">
                    <small class="text-muted fw-bold text-uppercase">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Active Only)</small>
                    <div class="d-flex align-items-baseline gap-2 mt-2">
                        <div class="stat-value text-dark" id="emp-count" style="font-size: 3.5rem;">0</div>
                        <div class="h5 fw-bold text-muted mb-0">‡∏Ñ‡∏ô</div>
                    </div>
                    <small class="text-muted"><i class="fas fa-check-circle text-success me-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å user_db ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="war-card bg-primary text-white border-0 shadow-lg">
                    <small class="fw-bold opacity-75 text-uppercase">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢/‡∏Ñ‡∏ô</small>
                    <div class="stat-value text-white mt-2" id="per-head" style="font-size: 2.2rem;">‡∏ø0</div>
                    <div class="mt-3 small border-top pt-2 opacity-75">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ √∑ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 51 ‡∏Ñ‡∏ô</div>
                </div>
            </div>
        </div>

        <div class="war-card bg-light border-0">
            <div class="row text-center">
                <div class="col-4 border-end">
                    <small class="text-muted fw-bold">‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô</small>
                    <div class="fw-bold text-dark h4 mb-0 mt-1" id="avg-daily">‡∏ø0</div>
                </div>
                <div class="col-4 border-end">
                    <small class="text-muted fw-bold">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î (Remaining)</small>
                    <div class="fw-bold text-danger h4 mb-0 mt-1" id="remaining">‡∏ø0</div>
                </div>
                <div class="col-4">
                    <small class="text-muted fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</small>
                    <div class="fw-bold text-dark h4 mb-0 mt-1">18 ‡∏ß‡∏±‡∏ô</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypSTaEhrniHAZTMAJdSK1UYwU2qmiSAeJ3jWKD2w9D16VBS2XLs9wJMEONsrS0GKIxtw/exec";
        let salesTotal = 0, staffCount = 0;

        async function init() {
            try {
                const sResp = await fetch(`${SCRIPT_URL}?action=getSalesData`);
                const sData = await sResp.json();
                salesTotal = sData.reduce((s, i) => s + (parseFloat(i.amount) || 0), 0);
                
                const session = JSON.parse(localStorage.getItem("user_session"));
                staffCount = session.allEmp.length; // ‡∏à‡∏∞‡πÑ‡∏î‡πâ 51 ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                
                calculate();
            } catch (e) { console.error(e); }
        }

        function calculate() {
            const target = parseFloat(document.getElementById('target-val').value) || 1;
            const progress = (salesTotal / target * 100).toFixed(1);
            const remain = target - salesTotal;
            const avg = remain > 0 ? (remain / 18) : 0;

            document.getElementById('cur-sales').innerText = '‡∏ø' + salesTotal.toLocaleString();
            document.getElementById('emp-count').innerText = staffCount;
            document.getElementById('per-head').innerText = '‡∏ø' + (salesTotal / staffCount).toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('prog-pct').innerText = progress + '% ‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢';
            document.getElementById('prog-bar').style.width = Math.min(progress, 100) + '%';
            document.getElementById('remaining').innerText = '‡∏ø' + (remain > 0 ? remain : 0).toLocaleString();
            document.getElementById('avg-daily').innerText = '‡∏ø' + avg.toLocaleString(undefined, {maximumFractionDigits: 0});
        }
        init();
    </script>
</body>
</html>
